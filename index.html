<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢å£“åŠ›æ¸¬è©¦æˆ°æƒ…å®¤ (V14 å­˜æª”ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #f0f3f5;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-light: #636e72;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --primary: #6c5ce7;
            --border-radius: 12px;
            --btn-save: #0984e3;
            --btn-export: #00cec9;
            --btn-import: #fab1a0;
        }
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; }

        /* --- æŒ‰éˆ•ç¾¤çµ„ (æ–°åŠŸèƒ½) --- */
        .action-bar {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;
            font-weight: bold; color: #fff; font-size: 0.95em; transition: opacity 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-save { background: var(--btn-save); }
        .btn-export { background: var(--btn-export); color: #fff; }
        .btn-import { background: var(--text-main); }
        .btn-reset { background: #b2bec3; }

        /* --- é ‚éƒ¨ç¸½è¦½å„€è¡¨æ¿ --- */
        .summary-dashboard {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;
            background: #fff; padding: 20px; border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 5px solid var(--primary);
        }
        .summary-item { text-align: center; border-right: 1px solid #eee; }
        .summary-item:last-child { border-right: none; }
        .summary-label { color: var(--text-light); font-size: 0.9em; margin-bottom: 5px; }
        .summary-val { font-size: 1.5em; font-weight: bold; font-family: Consolas, monospace; color: var(--text-main); }
        .summary-val.danger { color: var(--danger); }
        .summary-val.success { color: var(--success); }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .dashboard-panel {
            background: var(--card-bg); padding: 30px; border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 25px;
        }

        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .market-metrics { text-align: right; }
        .metric-big { font-size: 2em; font-weight: 800; color: var(--danger); font-family: Consolas, monospace; }
        
        /* æ»‘æ¡¿å€åŸŸ */
        .slider-wrapper { position: relative; margin: 60px 20px 50px 20px; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; z-index: 5; position: relative;}
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%;
            background: var(--text-main); border: 4px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            cursor: pointer; margin-top: -12px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 10px; cursor: pointer; 
            background: linear-gradient(90deg, #55efc4 0%, #fab1a0 45%, #d63031 75%, #2d3436 100%); 
            border-radius: 5px;
        }
        
        .markers { position: absolute; top: 25px; width: 100%; height: 30px; pointer-events: none; }
        .marker-item { position: absolute; transform: translateX(-50%); text-align: center; font-size: 11px; color: #666; line-height: 1.2; }
        .marker-item::before { content: ''; display: block; width: 1px; height: 8px; background: #999; margin: 0 auto 5px auto; }
        .marker-year { font-weight: bold; color: var(--text-main); font-size: 12px; display: block; margin-bottom: 2px;}

        /* æƒ…å¢ƒèªªæ˜æ¡† */
        .scenario-box {
            background: #ecf0f1; border-left: 5px solid var(--primary);
            padding: 15px; margin-top: 20px; border-radius: 4px; font-size: 0.95em; transition: all 0.3s;
        }
        .scenario-box.black-swan { background: #2d3436; color: #fff; border-left-color: #d63031; }

        /* --- å¡ç‰‡è¨­è¨ˆ --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }
        
        .card {
            background: var(--card-bg); border-radius: var(--border-radius); padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #eee;
            position: relative; overflow: hidden; transition: transform 0.2s;
        }
        .card.safe { border-top: 5px solid var(--success); }
        .card.warn { border-top: 5px solid var(--warning); background-color: #fffaf0; }
        .card.danger { border-top: 5px solid var(--danger); background-color: #fff5f5; }

        .card-header { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee; display:flex; justify-content:space-between; align-items:flex-start;}
        .asset-info { display: flex; flex-direction: column; }
        .asset-name { font-weight: bold; font-size: 1.1em; }
        .duration-badge { font-size: 0.8em; color: var(--primary); background: #e3f2fd; padding: 2px 6px; border-radius: 4px; margin-top: 5px; width: fit-content;}
        .status-tag { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; color: #fff; height: fit-content;}
        
        .input-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.9em; }
        .input-wrapper { display: flex; align-items: center; }
        .editable-input {
            width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;
            font-family: Consolas, monospace; font-weight: bold; font-size: 1em;
            text-align: right; margin-right: 5px; transition: border 0.3s; background: #fff;
        }
        .editable-input:focus { border-color: var(--primary); outline: none; background: #e8f0fe; }
        .unit { color: #888; font-size: 0.9em; }
        .val-sim { font-family: Consolas, monospace; font-weight: 600; color: var(--primary); }
        
        .bar-container { background: #eee; height: 8px; border-radius: 4px; margin-top: 15px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s ease, background-color 0.3s ease; }
        .bar-info { display: flex; justify-content: space-between; font-size: 0.8em; margin-top: 4px; color: var(--text-light); }

        /* è£œç¹³è­¦ç¤ºæ¡† */
        .alert-box {
            margin-top: 15px; padding: 10px; background: #ffe6e6; 
            border: 1px solid #ff4d4f; border-radius: 6px;
            color: #c0392b; font-size: 0.9em; display: none; animation: fadeIn 0.5s;
        }
        .alert-amount { font-weight: bold; font-size: 1.2em; display: block; margin-top: 2px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Tabs --- */
        .info-section { margin-top: 40px; background: #fff; border-radius: var(--border-radius); box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #eee; overflow-x: auto;}
        .tab-btn { padding: 15px 25px; cursor: pointer; border: none; background: transparent; font-weight: bold; color: var(--text-light); white-space: nowrap; }
        .tab-btn:hover { background: #e9ecef; }
        .tab-btn.active { color: var(--primary); background: #fff; border-bottom: 3px solid var(--primary); }
        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .info-block h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: var(--primary); margin-top: 0; }
        .info-list li { margin-bottom: 10px; }
        .highlight { background: #fff3cd; padding: 2px 5px; border-radius: 3px; }

        @media (max-width: 768px) { 
            .info-grid { grid-template-columns: 1fr; } 
            .summary-dashboard { grid-template-columns: 1fr 1fr; }
            .summary-item { border-right: none; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <!-- åŠŸèƒ½æŒ‰éˆ•åˆ— (New) -->
    <div class="action-bar">
        <button class="btn btn-save" onclick="saveData()">ğŸ’¾ å­˜æª” (ç€è¦½å™¨)</button>
        <button class="btn btn-export" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºè¨­å®š (JSON)</button>
        <button class="btn btn-import" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥è¨­å®š</button>
        <button class="btn btn-reset" onclick="resetData()">â†º é‡ç½®é è¨­</button>
        <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥æ¡† -->
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
    </div>

    <!-- ç¸½è¦½å„€è¡¨æ¿ -->
    <div class="summary-dashboard">
        <div class="summary-item">
            <div class="summary-label">ç¸½è³‡ç”¢ (æ¨¡æ“¬)</div>
            <div class="summary-val" id="total-assets">0 è¬</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">ç¸½å€Ÿæ¬¾</div>
            <div class="summary-val" id="total-loan">0 è¬</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">æ·¨å€¼</div>
            <div class="summary-val success" id="total-net">0 è¬</div>
        </div>
        <div class="summary-item" style="background:#fff1f0;">
            <div class="summary-label" style="color:#d63031;">ç¸½éœ€è£œç¹³ç¾é‡‘</div>
            <div class="summary-val danger" id="total-cash-needed">0 è¬</div>
        </div>
    </div>

    <!-- æ§åˆ¶å€ -->
    <div class="dashboard-panel">
        <div class="header-row">
            <div>
                <h2>ğŸ›ï¸ è³‡ç”¢å£“åŠ›æ¸¬è©¦æˆ°æƒ…å®¤ (V14)</h2>
                <p>é…ç½®ï¼šç©æ¥µå‹ä¿å–® (å®‰è¯/æ–½ç¾…å¾·) + ETF è³ªæŠ¼çµ„åˆ</p>
            </div>
            <div class="market-metrics">
                <div class="metric-label">æ¨¡æ“¬å¤§ç›¤è·Œå¹…</div>
                <div id="marketDropDisplay" class="metric-big">0%</div>
            </div>
        </div>

        <div class="slider-wrapper">
            <input type="range" id="crashSlider" min="0" max="70" value="0" step="1" oninput="calculateAll()">
            <div class="markers">
                <div class="marker-item" style="left: 0%">0%</div>
                <div class="marker-item" style="left: 14%"><span class="marker-year">ä¿®æ­£</span>-10%</div>
                <div class="marker-item" style="left: 43%"><span class="marker-year">2020/22</span>-30%</div>
                <div class="marker-item" style="left: 71%"><span class="marker-year">2008</span>-50%</div>
                <div class="marker-item" style="left: 95%; color:var(--danger);"><span class="marker-year">2000</span>-67%</div>
            </div>
        </div>

        <div id="scenarioBox" class="scenario-box">
            <strong id="scenarioTitle">ğŸŸ¢ ç‹€æ…‹ï¼šå¹³ç©©</strong><br>
            <span id="scenarioDesc">è«‹æ‹‰å‹•æ»‘æ¡¿æ¨¡æ“¬è‚¡ç½ã€‚æ‚¨å¯ä»¥é»æ“Šå·¦ä¸Šè§’ã€Œå­˜æª”ã€æŒ‰éˆ•ä¿å­˜ç›®å‰çš„æ•¸å­—ã€‚</span>
        </div>
    </div>

    <!-- å¡ç‰‡å€ -->
    <div class="grid" id="cardGrid"></div>

    <!-- è©³ç´°èªªæ˜å€ -->
    <div class="info-section">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab1')">âš ï¸ ç©æ¥µå‹åŸºé‡‘è§£æ</button>
            <button class="tab-btn" onclick="switchTab('tab2')">ğŸ›¡ï¸ å®‰å…¨æŒ‡æ¨™å®šç¾©</button>
            <button class="tab-btn" onclick="switchTab('tab3')">ğŸš¨ æ‡‰æ€¥ SOP</button>
        </div>

        <div id="tab1" class="tab-content active">
            <div class="info-grid">
                <div class="info-block">
                    <h3>ç‚ºä»€éº¼æ‚¨çš„ä¿å–®å±¬æ–¼ã€Œç©æ¥µå‹ã€ï¼Ÿ</h3>
                    <p>æ‚¨æŒæœ‰çš„ <span class="highlight">å®‰è¯æ”¶ç›Šæˆé•·</span> èˆ‡ <span class="highlight">æ–½ç¾…å¾·ç’°çƒ</span>ï¼Œçµæ§‹èˆ‡å‚³çµ±è‚¡å‚µå¹³è¡¡ä¸åŒï¼š</p>
                    <ul class="info-list">
                        <li><strong>æˆåˆ†çµæ§‹ (33/33/33)ï¼š</strong> é€šå¸¸ç”± 1/3 ç¾åœ‹è‚¡ç¥¨ + 1/3 å¯è½‰å‚µ + 1/3 é«˜æ”¶ç›Šå‚µ (åƒåœ¾å‚µ) çµ„æˆã€‚</li>
                        <li><strong>é¢¨éšªç‰¹æ€§ï¼š</strong>
                            <ul>
                                <li><strong>é«˜æ”¶ç›Šå‚µï¼š</strong> åœ¨å¸‚å ´ææ…Œæ™‚ï¼Œå®ƒæœƒåƒè‚¡ç¥¨ä¸€æ¨£ä¸‹è·Œï¼Œç„¡æ³•æä¾›ã€Œå…¬å‚µã€èˆ¬çš„é¿éšªåŠŸèƒ½ã€‚</li>
                            </ul>
                        </li>
                        <li><strong>Beta å€¼è¨­å®š (0.75)ï¼š</strong> å› æ­¤ï¼Œæˆ‘å€‘å°‡æ­¤æ¨¡æ“¬å™¨çš„æŠ—è·Œä¿‚æ•¸è¨­ç‚º 0.75 (å¤§ç›¤è·Œ 10%ï¼Œä¿å–®è·Œ 7.5%)ã€‚</li>
                    </ul>
                </div>
                <div class="info-block">
                    <h3>ç‚ºä»€éº¼ã€Œå®‰è¯ä¸»åŠ›ã€é–€æª»è¼ƒåš´ï¼Ÿ</h3>
                    <p>ä¿å–® D çš„å€Ÿæ¬¾æˆæ•¸è¢«é™åˆ¶åœ¨ <strong>6æˆ (è£œç¹³) / 7æˆ (æ–·é ­)</strong>ï¼Œé€™æ­£æ˜¯å› ç‚ºéŠ€è¡Œç«¯ä¹Ÿèªå®šè©²æ¨™çš„æ³¢å‹•è¼ƒå¤§ã€‚</p>
                    <ul class="info-list">
                        <li><strong>æ½›åœ¨é¢¨éšªï¼š</strong> åœ¨ 2000 å¹´èˆ‡ 2008 å¹´è‚¡ç½ä¸­ï¼Œé€™é¡ç©æ¥µå‹è³‡ç”¢çš„è·Œå¹…æ›¾ä¸€åº¦æ¥è¿‘è‚¡å¸‚å¤§ç›¤ã€‚</li>
                        <li><strong>æ‚¨çš„å„ªå‹¢ï¼š</strong> å¥½æ¶ˆæ¯æ˜¯ï¼Œé›–ç„¶é–€æª»è®Šåš´ï¼Œä½†æ‚¨åœ¨ä¿å–® D çš„å¯¦éš›å€Ÿæ¬¾æˆæ•¸åƒ… <strong>27.4%</strong>ï¼Œä¾ç„¶è™•æ–¼å®‰å…¨å€ã€‚</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="tab2" class="tab-content">
            <div class="info-grid">
                <div class="info-block">
                    <h3>ä¸€èˆ¬ä¿å–® (A, B, C)</h3>
                    <p>è£œç¹³ç·šï¼š80% | æ–·é ­ç·šï¼š90%</p>
                    <p class="highlight">å…¬å¼ï¼šè£œç¹³ = å€Ÿæ¬¾ - (å¸‚å€¼ Ã— 80%)</p>
                </div>
                <div class="info-block">
                    <h3>ä¿å–® D (å®‰è¯ä¸»åŠ›)</h3>
                    <p>è£œç¹³ç·šï¼š<span style="color:var(--danger)">60%</span> | æ–·é ­ç·šï¼š<span style="color:var(--danger)">70%</span></p>
                    <p class="highlight">å…¬å¼ï¼šè£œç¹³ = å€Ÿæ¬¾ - (å¸‚å€¼ Ã— 60%)</p>
                </div>
            </div>
        </div>

        <div id="tab3" class="tab-content">
            <div class="info-block">
                <h3>ğŸš¦ æ¥µç«¯è¡Œæƒ…æ‡‰è®Š SOP</h3>
                <ol>
                    <li><strong>ç¬¬ä¸€æ­¥ï¼šæª¢æŸ¥ã€Œä¿å–® E (é é›„)ã€çš„ç¾å€¼ã€‚</strong> 
                        è‹¥å…¶ç¾å€¼ > ç¸½éœ€è£œç¹³ç¾é‡‘ï¼Œæ­å–œæ‚¨ï¼Œæ‚¨å¯ä»¥éš¨æ™‚è³ªæŠ¼ä¿å–® E ä¾†å¡«è£œç¼ºå£ã€‚
                    </li>
                    <li><strong>ç¬¬äºŒæ­¥ï¼šETF äº¤å‰æ“”ä¿ã€‚</strong> 
                        è‹¥ ETF ç¶­æŒç‡ä»é«˜ï¼Œå¯å‘åˆ¸å•†å¢åŠ å€Ÿæ¬¾ï¼Œå°‡è³‡é‡‘è½‰å»å„Ÿé‚„ä¿å–®çš„æœ¬é‡‘ã€‚
                    </li>
                </ol>
            </div>
        </div>
    </div>
</div>

<script>
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // åŸå§‹é è¨­è³‡æ–™
    const defaultAssets = [
        { id: 'A', name: 'ä¿å–® A (æ³•å·´å¹´é‡‘)', type: 1, val: 47.7, loan: 21.5, limit1: 80, limit2: 90, duration: '1å¹´ 2å€‹æœˆ' },
        { id: 'B', name: 'ä¿å–® B (æ³•å·´å£½éšª)', type: 1, val: 147.8, loan: 68.5, limit1: 80, limit2: 90, duration: '1å¹´ 1å€‹æœˆ' },
        { id: 'C', name: 'ä¿å–® C (å®‰é”å¹´é‡‘)', type: 1, val: 180, loan: 84, limit1: 80, limit2: 90, duration: '2å€‹æœˆ' },
        { id: 'D', name: 'ä¿å–® D (å®‰è¯ä¸»åŠ›)', type: 1, val: 328, loan: 90, limit1: 60, limit2: 70, duration: '4å€‹æœˆ' },
        { id: 'E', name: 'ä¿å–® E (é é›„äººå£½)', type: 2, val: 15, loan: 8, limit1: 95, limit2: 100, duration: 'å„²è“„å‹' },
        { id: 'ETF', name: 'å°è‚¡ ETF çµ„åˆ', type: 3, val: 171, loan: 34.5, limit1: 130, limit2: 115, duration: 'è³ªæŠ¼' }
    ];

    // å·¥ä½œè³‡æ–™ (å¾ LocalStorage è®€å–æˆ–ä½¿ç”¨é è¨­)
    let currentAssets = JSON.parse(JSON.stringify(defaultAssets));

    // --- å­˜æª”ç›¸é—œåŠŸèƒ½ ---
    function loadData() {
        const saved = localStorage.getItem('my_portfolio_v14');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                // åƒ…æ›´æ–°æ•¸å€¼ï¼Œä¿ç•™é‚è¼¯çµæ§‹ (é¿å…ä»£ç¢¼æ›´æ–°å¾ŒèˆŠè³‡æ–™è“‹æ‰é‚è¼¯)
                currentAssets.forEach(asset => {
                    const found = parsed.find(p => p.id === asset.id);
                    if (found) {
                        asset.val = found.val;
                        asset.loan = found.loan;
                    }
                });
                console.log("å·²è®€å–å­˜æª”");
            } catch (e) {
                console.error("è®€å–å¤±æ•—", e);
            }
        }
    }

    function saveData() {
        // å¾ DOM æŠ“å–æœ€æ–°è¼¸å…¥å€¼
        updateCurrentAssetsFromDOM();
        // å„²å­˜ç°¡å–®çµæ§‹
        const saveObj = currentAssets.map(a => ({ id: a.id, val: a.val, loan: a.loan }));
        localStorage.setItem('my_portfolio_v14', JSON.stringify(saveObj));
        alert('âœ… å·²å„²å­˜è‡³ç€è¦½å™¨ï¼ä¸‹æ¬¡é–‹å•Ÿå°‡è‡ªå‹•è®€å–ã€‚');
    }

    function exportData() {
        updateCurrentAssetsFromDOM();
        const saveObj = currentAssets.map(a => ({ id: a.id, val: a.val, loan: a.loan }));
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(saveObj));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "my_portfolio_backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const parsed = JSON.parse(e.target.result);
                currentAssets.forEach(asset => {
                    const found = parsed.find(p => p.id === asset.id);
                    if (found) {
                        asset.val = found.val;
                        asset.loan = found.loan;
                    }
                });
                renderAssets();
                alert('âœ… åŒ¯å…¥æˆåŠŸï¼');
            } catch (err) {
                alert('âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
            }
        };
        reader.readAsText(file);
        input.value = ''; // é‡ç½® input ä»¥ä¾¿é‡è¤‡é¸æ“‡åŒä¸€æª”æ¡ˆ
    }

    function resetData() {
        if(confirm('ç¢ºå®šè¦é‡ç½®å›é è¨­å€¼å—ï¼Ÿ')) {
            currentAssets = JSON.parse(JSON.stringify(defaultAssets));
            renderAssets();
            localStorage.removeItem('my_portfolio_v14');
        }
    }

    function updateCurrentAssetsFromDOM() {
        currentAssets.forEach(item => {
            const inputVal = parseFloat(document.getElementById(`input-val-${item.id}`).value);
            const inputLoan = parseFloat(document.getElementById(`input-loan-${item.id}`).value);
            if(!isNaN(inputVal)) item.val = inputVal;
            if(!isNaN(inputLoan)) item.loan = inputLoan;
        });
    }

    // --- æ¸²æŸ“èˆ‡è¨ˆç®— ---

    function renderAssets() {
        const grid = document.getElementById('cardGrid');
        grid.innerHTML = '';
        currentAssets.forEach(item => {
            const isETF = item.type === 3;
            const riskLabel = isETF ? 'ç¶­æŒç‡' : 'å€Ÿæ¬¾æ¯”';
            let safeText = isETF ? 'å®‰å…¨ > 130%' : 'å®‰å…¨ < 80%';
            if(item.id === 'D') safeText = 'å®‰å…¨ < 60%';

            const html = `
            <div class="card safe" id="card-${item.id}">
                <div class="card-header">
                    <div class="asset-info">
                        <span class="asset-name">${item.name}</span>
                        <span class="duration-badge">ğŸ•’ ${item.duration}</span>
                    </div>
                    <span class="status-tag" id="tag-${item.id}" style="background:var(--success)">å®‰å…¨</span>
                </div>
                <div class="input-group">
                    <span>ç•¶å‰ç¾å€¼</span>
                    <div class="input-wrapper"><input type="number" class="editable-input" id="input-val-${item.id}" value="${item.val}" oninput="calculateAll()"><span class="unit">è¬</span></div>
                </div>
                <div class="input-group">
                    <span>å€Ÿæ¬¾é‡‘é¡</span>
                    <div class="input-wrapper"><input type="number" class="editable-input" id="input-loan-${item.id}" value="${item.loan}" oninput="calculateAll()"><span class="unit">è¬</span></div>
                </div>
                <div class="input-group" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                    <span>ç½å¾Œæ¨¡æ“¬å€¼</span>
                    <span class="val-sim" id="sim-val-${item.id}">-- è¬</span>
                </div>
                
                <div id="alert-${item.id}" class="alert-box">
                    âš ï¸ <span id="alert-msg-${item.id}">éœ€è£œç¹³æœ¬é‡‘</span>
                    <span id="alert-amount-${item.id}" class="alert-amount">0 è¬</span>
                </div>

                <div class="bar-container"><div class="bar-fill" id="bar-${item.id}" style="width: 50%; background: var(--success);"></div></div>
                <div class="bar-info"><span id="risk-text-${item.id}">${riskLabel}: --%</span><span>${safeText}</span></div>
            </div>`;
            grid.innerHTML += html;
        });
        calculateAll();
    }

    function calculateAll() {
        const sliderVal = document.getElementById('crashSlider').value;
        const marketDropPct = parseInt(sliderVal);
        document.getElementById('marketDropDisplay').innerText = `-${marketDropPct}%`;
        updateScenarioText(marketDropPct);

        let totalAssetsSim = 0;
        let totalLoanSum = 0;
        let totalCashNeeded = 0;

        currentAssets.forEach(item => {
            // å¾ DOM å³æ™‚è®€å–ï¼Œä»¥ç¢ºä¿è¨ˆç®—åŸºç¤æ˜¯ç•¶ä¸‹è¼¸å…¥æ¡†çš„å€¼
            const inputVal = parseFloat(document.getElementById(`input-val-${item.id}`).value) || 0;
            const inputLoan = parseFloat(document.getElementById(`input-loan-${item.id}`).value) || 0;

            let beta = (item.type === 1) ? 0.75 : (item.type === 3) ? 0.55 : 0;
            const assetDropPct = marketDropPct * beta;
            const simulatedVal = inputVal * (1 - (assetDropPct / 100));

            totalAssetsSim += simulatedVal;
            totalLoanSum += inputLoan;

            let riskMetric = 0; let status = 'safe'; let statusText = 'å®‰å…¨'; let color = 'var(--success)'; let barWidth = 0;
            let cashNeeded = 0;

            if (item.type === 1 || item.type === 2) {
                if (simulatedVal > 0) riskMetric = (inputLoan / simulatedVal) * 100; else riskMetric = 999;
                if (riskMetric >= item.limit2) { status = 'danger'; statusText = 'æ–·é ­'; color = 'var(--danger)'; }
                else if (riskMetric >= item.limit1) { status = 'warn'; statusText = 'éœ€è£œç¹³'; color = 'var(--warning)'; }

                if (riskMetric >= item.limit1) {
                    cashNeeded = inputLoan - (simulatedVal * (item.limit1 / 100));
                }
                barWidth = Math.min(riskMetric, 100);
                document.getElementById(`risk-text-${item.id}`).innerText = `å€Ÿæ¬¾æ¯”: ${riskMetric.toFixed(1)}%`;
            } else {
                if (inputLoan > 0) riskMetric = (simulatedVal / inputLoan) * 100; else riskMetric = 999;
                if (riskMetric <= item.limit2) { status = 'danger'; statusText = 'æ–·é ­'; color = 'var(--danger)'; }
                else if (riskMetric <= item.limit1) { status = 'warn'; statusText = 'è¿½ç¹³'; color = 'var(--warning)'; }

                if (riskMetric <= item.limit1) {
                    cashNeeded = inputLoan - (simulatedVal / 1.66);
                }
                barWidth = Math.min((riskMetric / 300) * 100, 100);
                document.getElementById(`risk-text-${item.id}`).innerText = `ç¶­æŒç‡: ${riskMetric.toFixed(0)}%`;
            }

            if(cashNeeded > 0) totalCashNeeded += cashNeeded;

            document.getElementById(`sim-val-${item.id}`).innerText = `${simulatedVal.toFixed(1)} è¬`;
            if (marketDropPct > 0) document.getElementById(`sim-val-${item.id}`).innerHTML += ` <span style='font-size:0.8em; color:#999'>(-${assetDropPct.toFixed(1)}%)</span>`;
            
            document.getElementById(`tag-${item.id}`).innerText = statusText;
            document.getElementById(`tag-${item.id}`).style.background = color;
            document.getElementById(`bar-${item.id}`).style.width = `${barWidth}%`;
            document.getElementById(`bar-${item.id}`).style.background = color;
            document.getElementById(`card-${item.id}`).className = `card ${status}`;

            const alertBox = document.getElementById(`alert-${item.id}`);
            if (cashNeeded > 0) {
                alertBox.style.display = 'block';
                document.getElementById(`alert-msg-${item.id}`).innerText = item.type===3 ? "éœ€è£œå›ç¶­æŒç‡166%" : `éœ€é™è‡³å€Ÿæ¬¾æ¯”${item.limit1}%`;
                document.getElementById(`alert-amount-${item.id}`).innerText = `${Math.ceil(cashNeeded)} è¬`;
            } else {
                alertBox.style.display = 'none';
            }
        });

        document.getElementById('total-assets').innerText = `${Math.round(totalAssetsSim)} è¬`;
        document.getElementById('total-loan').innerText = `${Math.round(totalLoanSum)} è¬`;
        document.getElementById('total-net').innerText = `${Math.round(totalAssetsSim - totalLoanSum)} è¬`;
        
        const totalCashEl = document.getElementById('total-cash-needed');
        if (totalCashNeeded > 0) {
            totalCashEl.innerText = `${Math.ceil(totalCashNeeded)} è¬`;
            totalCashEl.style.color = 'var(--danger)';
        } else {
            totalCashEl.innerText = "0";
            totalCashEl.style.color = 'var(--success)';
        }
    }

    function updateScenarioText(pct) {
        const title = document.getElementById('scenarioTitle');
        const desc = document.getElementById('scenarioDesc');
        const box = document.getElementById('scenarioBox');
        box.className = "scenario-box"; title.style.color = "";

        if(pct === 0) {
            title.innerHTML = "ğŸŸ¢ ç‹€æ…‹ï¼šå¹³ç©© (ç·¨è¼¯æ¨¡å¼)";
            desc.innerHTML = "æ‰€æœ‰æ•¸å€¼ç‚ºå³æ™‚è¨ˆç®—ã€‚é»æ“Šå·¦ä¸Šè§’ã€Œå­˜æª”ã€å¯ä¿å­˜ç•¶å‰è¨­å®šã€‚";
        } else if(pct < 35) {
            title.innerHTML = "ğŸŸ¡ æ¨¡æ“¬æƒ…å¢ƒï¼š2020 / 2022 (-30%)";
            desc.innerHTML = "ç©æ¥µå‹ä¿å–®ç¸®æ°´ï¼Œä½†å› æ§“æ¡¿æ§åˆ¶å¾—å®œï¼Œç³»çµ±æ€§é¢¨éšªä»ä½ã€‚";
            title.style.color = "#e67e22";
        } else if(pct < 60) {
            title.innerHTML = "ğŸŸ  æ¨¡æ“¬æƒ…å¢ƒï¼š2008 é‡‘èæµ·å˜¯ (-50%)";
            desc.innerHTML = "å£“åŠ›å€ã€‚è«‹æª¢æŸ¥ä¸Šæ–¹ç´…è‰²æ•¸å­—ï¼Œé€™ä»£è¡¨æ‚¨éœ€è¦æº–å‚™çš„ç·Šæ€¥é å‚™é‡‘ã€‚";
            title.style.color = "var(--danger)";
        } else {
            title.innerHTML = "âš« æ¨¡æ“¬æƒ…å¢ƒï¼š2000 ç¶²è·¯æ³¡æ²« (-67%)";
            desc.innerHTML = "æ¥µé™æ¸¬è©¦ã€‚æ­¤æ™‚è‹¥ä¿å–® E çš„åƒ¹å€¼å¤§æ–¼ã€Œç¸½éœ€è£œç¹³ç¾é‡‘ã€ï¼Œæ‚¨å°±å®‰å…¨äº†ã€‚";
            box.className = "scenario-box black-swan";
        }
    }

    // åˆå§‹åŒ–ï¼šå…ˆè®€å–å­˜æª”ï¼Œå†æ¸²æŸ“
    loadData();
    renderAssets();

</script>

</body>
</html>
